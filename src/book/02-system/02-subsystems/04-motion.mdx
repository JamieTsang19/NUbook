---
section: System
chapter: Subsystems
title: Motion
description: Motion and how it works in the NUbots codebase.
slug: /system/subsystems/motion
---

The motion subsystem contains modules that are responsible for walking, kicking, moving the head, and running scripts. They perform these motions by sending servo commands (called targets) to the motors.

The Script Engine is detailed on this page, while Script Runner and Script Tuner can be found on the [Behaviour](/system/subsystems/behaviour#script-runner) page.

## Kinematics

Kinematics specifies the relationship between the position of two points on a chain and the joint angles on each section of the chain. For example, the leg of a robot contains servos in the hip, knee and ankle which rotate these parts. If we know the angles of each of these servos, we can use Forward Kinematics to find the [transform](/mathematics#Homogeneous-Transformations) from the torso to the foot. If we want to move the foot somewhere relative to the torso, and we have the transform for it, we can use Inverse Kinematics to find the joint positions.

### Forward Kinematics

#### Leg

_image of leg_

[Forward Kinematics](https://github.com/NUbots/NUbots/blob/master/shared/utility/motion/ForwardKinematics.h) begins with the identity matrix

$$
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1 \end{bmatrix}
$$

Which we can think of as the transformation matrix from the torso to the torso.

We move this matrix to the hip, using the hip offset from the torso config value in the [KinematicsConfiguration.yaml](https://github.com/NUbots/NUbots/blob/10dcb7a3d918b663a8db23f8fe966fc89ccbf413/module/motion/KinematicsConfiguration/data/config/KinematicsConfiguration.yaml#L3) file.

The matrix is then rotated by $/pi/2$ around the y-axis to face down the leg. We then rotate again using the current servo angles for the hip yaw, pitch and roll. The transform is then translated down the length of the upper leg and then rotated about the knee pitch, which is the only degree of freedom in the knee.

The transform is translated down the lower leg to the ankle. The ankle has two degrees of freedom, pitch and roll. The transform is rotated by pitch first and then roll.

Since the transform was rotated to face down the leg, we now rotate the y-axis back up by $-\pi/2$ to face towards the toe. The transform is translated down to the bottom of the foot.

This final matrix is the transform from the torso to the foot. Any transform on the chain can be retrieved by forward kinematics, however to get the correct torso to foot transform, the `ANKLE_ROLL` servo ID must be specified when calling `calculateLegJointPosition`.

#### Arm

#### Head

### Inverse Kinematics

# Script Engine

Scripts are static motions for the robot. They specify what joint angles to move to and how long the robot should take to get to those joint angles. For example, standing up is a script telling the robot to move its joints to the stand position over one second. There can be many of these position specifications in sequence to make the robot do more complex movements like getting up or kicking.

To learn how to tune scripts, see the [ScriptTuner guide](/guides/main/tuning-and-running-scripts#script-tuner).

## Messages

To execute a script, we emit an "execute script" message describing the script to execute. This message is received in the ScriptEngine, which executes the appropriate script. These are specified in [Script.h](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/shared/extension/Script.h) as [ExecuteScriptByName](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/shared/extension/Script.h#L224) and [ExecuteScript](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/shared/extension/Script.h#L261).

`ExecuteScriptByName` takes

- a subsumption ID (this is used to determine servo access priority)
- the name of the script/s as a string or a vector of strings
- the duration of the scripts
- the time that these scripts should start executing

An example of receiving this message is in [ScriptEngine.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/motion/ScriptEngine/src/ScriptEngine.cpp#L51).

```cpp
on<Trigger<ExecuteScriptByName>>().then([this](const ExecuteScriptByName& command) {...}
```

An example of emitting this message is in [KickScript.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/behaviour/skills/KickScript/src/KickScript.cpp#L102)

```cpp
emit(std::make_unique<ExecuteScriptByName>(
    id, std::vector<std::string>({"Stand.yaml", "KickRight.yaml", "Stand.yaml"})));
```

Note these are only the names of the scripts, not the full paths. The names correspond to the names of YAML files in the [scripts folder](https://github.com/NUbots/NUbots/tree/16b4b20faf69c2c12b52e9ffd28c546a612dc033/module/motion/ScriptEngine/data/scripts).

In addition to using the name of a script, we can also use [an instance of Script](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/shared/extension/Script.h#L43) directly. `Script` can be instantiated with all the information for the script to execute, and can be emitted using the `ExecuteScript` message. `ExecuteScript` takes:

- a subsumption ID (this is used to determine servo access priority)
- a Script or vector of Scripts
- the duration of the scripts
- the time that these scripts should start executing

An example of receiving this messages is in [ScriptEngine.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/motion/ScriptEngine/src/ScriptEngine.cpp#L71)

```cpp
on<Trigger<ExecuteScript>>().then([this](const ExecuteScript& command) {...}
```

An example of emitting this message is in [ScriptTuner.cpp](https://github.com/NUbots/NUbots/blob/96357855b059cd499021552b3e25a4b158828dc5/module/behaviour/tools/ScriptTuner/src/ScriptTuner.cpp#L590)

```cpp
emit(std::make_unique<ExecuteScript>(id, script, NUClear::clock::now()));
```

The [ScriptEngine](https://github.com/NUbots/NUbots/tree/96357855b059cd499021552b3e25a4b158828dc5/module/motion/ScriptEngine) module receives either of these messages and processes the information for the script. It collects the servo positions and time for each frame and modifies them if needed based on the given duration and start time in the message. The information is then emitted as a [ServoCommand](https://github.com/NUbots/NUbots/blob/cbb5d3ebc2a7c56944ec9afe3f70faf7e2900217/shared/message/behaviour/ServoCommand.proto) message.

## Script files

The script files are YAML files specifying a duration and list of servo targets, in a format like the following:

```yaml
- duration: 1000
  targets:
    - id: HEAD_YAW
      position: 0
      gain: 30
      torque: 100
    - id: HEAD_PITCH
      position: 0.5
      gain: 30
      torque: 100
    - id: R_HIP_YAW
      position: -0.03
      gain: 20
      torque: 100
```

The fields are described in the table below.

| Field      | Description                                                                                                                                                    |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `duration` | An integer in milliseconds.                                                                                                                                    |
| `position` | A float representing the angle of the servo in radians.                                                                                                        |
| `gain`     | A float representing how much effort the servo will use to get to the target position. Gain is often between 10 and 30.                                        |
| `torque`   | A float, where 0 represents no torque and 100 represents torque being on. Torque is 100 unless you want that servo relaxed, in which case it will be 0.        |
| `id`       | One of the servo IDs listed in [ServoID.h](https://github.com/NUbots/NUbots/blob/467f458c687419056e2487fe468c7f22d19a6965/shared/utility/input/ServoID.h#L30). |

Script files can be found in the ScriptEngine module. Scripts can be specific to a robot. More on scripts can be found on the [Configuration and Script System](/system/foundations/config-script) page.
